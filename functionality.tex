\chapter{Implementation}
\subsection{Coarse-graining engine}
\votca can be divided into two main parts. A C++ kernel, which includes various coarse-graining tools and is capable of processing topologies and trajectories, and a scripting enginge to steers the iterative procedures.

These tools include calculations of probability distributions of bonded and non-bonded interactions, correlation and autocorrelation functions, and updates for the coarse-grained pair potential. Analysis tools of the MD package can also be integrated into the coarse-graining workflow, as needed.

The package offers a flexible framework for reading, manipulating and analyzing of MD/SD/MC topologies and trajectories. Its core is modular and new file formats can be integrated without changing the existing code. Currently, an interface for \gromacs~\cite{gromacs4} topologies and trajectories is provided.

The coarse-graining procedure itself is controlled by several Extensible Markup Language (\xml) input files, which contain mapping and other options required for the workflow control. For the mapping, it is possible to select groups of interactions which are used for the coarse-graininged analysis. 
%It is possible to generate exclusion lists for Boltzmann inversion of bonded interactions or virtual sites for back-mapping.

\input{functionality//mapping}

\section{Topologies}
A topology is defined as a set of beads with a certain bead type which are connected by bonded interactions.
Votca can read topologies in the \gromacs tpr format. Additionally, it can use a pdb file as topology, however, not all information are given in a pdb file and are not defined. If a pdb topology is used, it is recommended to fill additional molecule information using the xml advanced topology handling feature (see. \sect{sec:adv_topology})
\subsection{Manual topology handling}
\label{sec:adv_topology}
Many file formats do not have a clear definition of a molecules. This can lead to problems, especially if a simulation contains several multiple molecules. Since during the coarse graining, the molecule type is identified by a name tag, names must be set properly. \votca offers the possibility to read a topology and later on modify parts of it. Everything is defined in an xml topology file.

Also \gromacs did not store molecule names in previous versions. This was introduced in a newer release. If possible, always provide a recent .tpr file which contains molecule names. For old topologies, rerun grompp if possible to get a recent file.

If a system with multiple molecule types is processed, but no molecule names are present, molecule names have to be specified manually as described in this section that \votca can choose the correct mapping scheme..

If no molecule information is present at all, they can be created. An for a topology file that reads in last.pdb and then creates molecules is:
\begin{lstlisting}
<topology base="last.pdb">
  <molecules>
    <clear/>
    <define name="mCP" first="1" nbeads="52" nmols="216"/>
  </molecules>
</topology>
\end{lstlisting}
<clear/> clears all bolecule information that were present before.

If the file format the topology is read from only does not support molecules names, \votca offers the possibility to define topologies in an xml file and manipulate the molecule names after reading. A short example:
\begin{lstlisting}
 <topology base="topol.tpr">
   <molecules>
     <rename name="PPY3" range="1:125"/>
     <rename name="Cl" range="126:250"/>
   </molecules>
 </topology>
\end{lstlisting}
Here, first to file topol.tpr is loaded. The file supports molecules but does not give a name tag. Afterwards, Molecules are renamed. This file can be loaded as any other topology.

To use the new topology, create a file using the schema above and save it as .xml. To use it in the program, you'll have to give several coarse graining definitions, separated by ;. If you saved the example above as newtop.xml, use 

\subsection{Trajectories}
A trajectory is defined as a set of frames containing coordinates and eventually velecities and forces for the beads of a topology.
VOTCA currently supports trr, xtc, pdb and gro as trajector formats.

\input{functionality//inverse}




