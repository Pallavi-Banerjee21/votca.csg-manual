\chapter{Implementation}
\subsection{Coarse-graining engine}
\votca can be divided into two main parts. A C++ kernel, which includes various coarse-graining tools and is capable of processing topologies and trajectories, and a scripting enginge to steers the iterative procedures.

These tools include calculations of probability distributions of bonded and non-bonded interactions, correlation and autocorrelation functions, and updates for the coarse-grained pair potential. Analysis tools of the MD package can also be integrated into the coarse-graining workflow, as needed.

The package offers a flexible framework for reading, manipulating and analyzing of MD/SD/MC topologies and trajectories. Its core is modular and new file formats can be integrated without changing the existing code. Currently, an interface for \gromacs~\cite{gromacs4} topologies and trajectories is provided.

The coarse-graining procedure itself is controlled by several Extensible Markup Language (\xml) input files, which contain mapping and other options required for the workflow control. For the mapping, it is possible to select groups of interactions which are used for the coarse-graininged analysis. 
%It is possible to generate exclusion lists for Boltzmann inversion of bonded interactions or virtual sites for back-mapping.

\input{functionality//mapping}

\section{Topologies}
A topology is defined as a set of beads with a certain bead type which are connected by bonded interactions.
\votca can read topologies in the \gromacs tpr format. However, it can also use a pdb file as topology, but, not all information are given or defined in this file format. If a pdb topology is used, it is recommended to fill in any additional molecule information using the xml advanced topology handling feature (see. \sect{sec:adv_topology})
\subsection{Manual topology handling}
\label{sec:adv_topology}
Many file formats do not have a clear definition of molecules. This can lead to problems, especially if a simulation contains several molecules with multiple types. Since during the coarse graining, the molecule type is identified by a name tag, names must also be set properly. \votca also offers the possibility to read a topology and later on modify parts of it. Everything is based on a definiton in an \xml topology file. This new \xml topology can then be used as topology in the \progopt{--tpr} option, as any other topology file. 

As \gromacs did not store molecule names in previous versions, but has introduced this feature in a newer release,  a recent .tpr file which contains molecule names should always be provided. For old topologies, rerun \gromacs \textbf{grompp} if possible to get a recent file. 

If no molecule information is present at all, it has to be manually defined. An example for a topology file that reads in last.pdb and then creates proper molecule definitions is:
\begin{lstlisting}
<topology base="last.pdb">
  <molecules>
    <clear/>
    <define name="mCP" first="1" nbeads="52" nmols="216"/>
  </molecules>
</topology>
\end{lstlisting}
where $<$clear/$>$ clears all molecule information that were present before.

If molecule information is already present in the parent topology, but molecule do not have proper names, molecules can be renamed. A short example is
\begin{lstlisting}
 <topology base="topol.tpr">
   <molecules>
     <rename name="PPY3" range="1:125"/>
     <rename name="Cl" range="126:250"/>
   </molecules>
 </topology>
\end{lstlisting}
Here, first the file topol.tpr is loaded, subsequently, molecules are renamed.

\subsection{Trajectories}
A trajectory is defined as a set of frames containing coordinates and eventually velecities and forces for the beads of a topology.
\votca currently supports trr, xtc, pdb and gro as trajector formats.

\input{functionality//inverse}




