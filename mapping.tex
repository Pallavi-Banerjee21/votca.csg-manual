\chapter{Mapping}
\label{sec:mapping}

\section{Mapping files}

Mapping relates atomistic and coarse-grained representations of the system. It is organized as follows: for each molecule {\em type} a mapping file is created. When used as a command option, these files are combined in a list separated by a semicolon, e.~g. \progopt{--cg}~\texttt{"protein.xml;solvent.xml"}.

\begin{wrapfigure}{ht}{6cm}
  \includegraphics[width=6cm]{usage/fig/propane.eps}
  \caption{Atom labeling and mapping from an all-atom to a united atom representation of a propane molecule.
  \label{fig:propane_map}
}
\end{wrapfigure}

Each mapping file contains a {\em topology} of the coarse-grained molecule and a list of {\em maps}. Topology specifies coarse-grained beads and bonded interactions between them. Each coarse-grained bead has a name, type, a list of atoms which belong it, and a link to a map. A map is a \hyperref[sec:mapping_operator]{set of weights} $c_{Ii}$ for an atom $i$ belonging to the bead $I$. It is used to calculate the position of a coarse-grained bead from the positions of atoms which belong to it. Note that $c_{Ii}$ will be automatically re-normalized if their sum is not equal to 1, i.~e. in the case of a center-of-mass mapping one can simply specify atomic masses.
A complete reference for mapping file definitions can be found in sec.~\ref{sec:ref_mapping}.

As an example, we will describe here a mapping file of a united atom model of a propane molecule, chemical structure of which is shown in fig.~\ref{fig:intro:propane}. In this coarse-grained model two bead types (A,B) and three beads (A1, B1, A2) are defined, as shown in fig.~\ref{fig:propane_map}. We will use centers of mass of the beads as  coarse-grained coordinates.

Exempts from the \texttt{propane.xml} file of the tutorial are shown below. The \mapopt{name} tag provides molecule name in the coarse-grained topology. The \mapopt{ident} tag must match the name of the molecule in the atomistic representation. In the \mapopt{topology} section all beads are defined by specifying bead name (A1, B1, A2), type, and atoms belonging to this bead in the form \texttt{residue id:residue name:atom name}. For each bead a map has to be specified, which is defined later in \mapopt{maps} section. Note that bead \hyperlink{\mapref{topology.cg_beads.cg_bead.type}}{type} and \hyperlink{\mapref{maps.map}}{map} can be different, which might be useful in a situation when chemically different beads (A1, B1) are assigned the same bead type. After defining all beads the bonded interactions of the coarse-grained molecule must be specified in the \mapopt{topology.cg_bonded} section. Finally, in the \hyperlink{\mapref{topology.cg_beads.cg_bead.mapping}}{mapping section}, the mapping coefficients are defined.

\framebox{
\lstinputlisting{functionality/propane.xml}
}

\section{Advanced topology handling}
\label{sec:adv_topology}


A topology is completely specified by a set of beads, their types, and a list of bonded interactions. \votca is able to read topologies in the \gromacs .tpr format. For example, one can create a coarse-grained topology based on the mapping file and atomistic \gromacs topology using \prog{csg_gmxtopol}.
\begin{verbatim}
  csg_gmxtopol --top topol.tpr --cg propane.xml --out out.top
\end{verbatim}


In some cases, however, one might want to use a .pdb file which does not contain all information about the atomistic topology. In this case, additional information can be supplied in the xml mapping file.

A typical example is lack of a clear definition of molecules, which can be a problem for simulations with several molecules with multiple types. During coarse-graining, the molecule type is identified by a name tag, names must be clearly identified. To do this, it is possible to read a topology and then modify parts of it. The new \xml topology can be used with the \progopt{--tpr} option, as any other topology file.

For example, if information about a molecule is not present at all, one can create one from a .pdb file, as shown in this example
\begin{lstlisting}
<topology base="snapshot.pdb">
  <molecules>
    <clear/>
    <define name="mCP" first="1" nbeads="52" nmols="216"/>
  </molecules>
</topology>
\end{lstlisting}
where $<$clear/$>$ clears all information that was present before.

If molecule information is already present in the parent topology but molecules are not named properly, one can rename them
\begin{lstlisting}
 <topology base="topol.tpr">
   <molecules>
     <rename name="PPY3" range="1:125"/>
     <rename name="Cl" range="126:250"/>
   </molecules>
 </topology>
\end{lstlisting}
Here, the file topol.tpr is loaded and then all molecules are renamed.

 Old versions of \gromacs did not store molecule names. In order to use this feature, a recent .tpr file containing molecule names should always be provided. For old topologies, rerun \gromacs \progex{grompp} to update the old topology file.


\section{Trajectories}
A trajectory is a set of frames containing coordinates (velocities and forces) for the beads defined in the topology. \votca currently supports .trr, .xtc, .pdb and .gro trajectory formats.

Once the mapping file is created, it is easy to convert an atomistic to a coarse-grained trajectory using \prog{csg_map}
\begin{verbatim}
  csg_map --top topol.tpr --trj traj.trr --cg propane.xml --out cg.gro
\end{verbatim}




