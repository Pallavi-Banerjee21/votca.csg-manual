SHELL=/bin/bash
DIR:=$(shell pwd | sed 's@^.*/\([^/]*/[^/]*\)$$@\1@' )
BINS:=$(shell ls `dirname \`which csg_property\``/csg_* | xargs -n1 basename )
BINS2:=$(shell ls `dirname \`which csg_property\``/multi_g_* | xargs -n1 basename )

.PHONY: clean bootstrap

all: all.tex
wiki: all.wiki

all.tex: $(BINSTEX)
	echo $(BINSTEX) | \
	sed -e 's/\.tex[[:space:]]*/\n/g' | \
	sed -e '$$d' -e 's@.*@\\input{$(DIR)/&}@' > $@

all.wiki: $(BINSWIKI)
	cat $(BINSWIKI) > $@

%.t2t: 
	./help2t2t.sh $* > $@	

%.tex: %.t2t
	./txt2tags -t tex --no-header --infile $< --outfile $@

%.wiki: %.t2t
	./txt2tags -t wiki --no-header --infile $< --outfile $@

clean: 
	rm -f $(BINST2T)
	rm -f $(BINSTEX) all.tex
	rm -f $(BINSWIKI) all.wiki
	rm -f *~
	rm -f Makefile

bootstrap: Makefile.in
	@if [ -z "${CSGSHARE}" ]; then \
	  echo CSGSHARE not defined >&2; \
	  exit 1; \
	fi
	@if ! which csg_property > /dev/null 2>&1; then\
	  echo csg_property not found;\
	  exit 1;\
	fi
	echo $(BINS) $(BINS2)| sed 's/[[:space:]]\+/\n/g' | sed -e 's/.*/\t&.tex\\/' -e '1i BINST2T=\\' > Makefile
	echo >> Makefile
	echo $(BINS) $(BINS2) | sed 's/[[:space:]]\+/\n/g' | sed -e 's/.*/\t&.tex\\/' -e '1i BINSTEX=\\' >> Makefile
	echo >> Makefile
	echo $(BINS) $(BINS2) | sed 's/[[:space:]]\+/\n/g' | sed -e 's/.*/\t&.wiki\\/' -e '1i BINSWIKI=\\' >> Makefile
	echo >> Makefile
	cat Makefile.in >> Makefile
	
