SHELL=/bin/bash
DIR:=$(shell pwd | sed 's@^.*/\([^/]*/[^/]*\)$$@\1@' )
SCRIPTS:=$(shell csg_call -l | sed -e '1d' -e '/\.\(sh\|pl\)/!d' | awk '{print $$3}' | sort -u )

.PHONY: clean bootstrap
.SECONDARY:

all: all.tex csg_table.tex 
wiki: all.wiki
	
all.tex: $(SCRIPTSTEX)
	echo $(SCRIPTSTEX) | \
	sed -e 's/\.tex[[:space:]]*/\n/g' | \
	sed -e '$$d' -e 's@.*@\\input{$(DIR)/&}@' > $@

all.wiki: $(SCRIPTSWIKI)
	cat $(SCRIPTSWIKI) > $@

csg_table.t2t:
	./call2t2t.sh > $@

csg_table.tex: csg_table.t2t
	./txt2tags -t tex --no-header --infile $< --outfile $@
	sed -i -e 's/{tabular}/{longtable}/' $@

%.t2t: 
	./help2t2t.sh csg_call --direct $* > $@	

%.tex: %.t2t
	./txt2tags -t tex --no-header --infile $< --outfile $@

%.wiki: %.t2t
	./txt2tags -t wiki --no-header --infile $< --outfile $@

clean: 
	rm -f $(SCRIPTST2T) csg_table.t2t
	rm -f $(SCRIPTSTEX) all.tex csg_table.tex
	rm -f $(SCRIPTSWIKI) all.wiki
	rm -f *~
	rm -f Makefile

bootstrap: 
	@if ! which csg_call > /dev/null 2>&1; then\
	  echo csg_call not found;\
	  exit 1;\
	fi
	echo $(SCRIPTS) | sed 's/[[:space:]]\+/\n/g' | sed -e 's/.*/\t&.t2t\\/' -e '1i SCRIPTST2T=\\' > Makefile
	echo >> Makefile
	echo $(SCRIPTS) | sed 's/[[:space:]]\+/\n/g' | sed -e 's/.*/\t&.tex\\/' -e '1i SCRIPTSTEX=\\' >> Makefile
	echo >> Makefile
	echo $(SCRIPTS) | sed 's/[[:space:]]\+/\n/g' | sed -e 's/.*/\t&.wiki\\/' -e '1i SCRIPTSWIKI=\\' >> Makefile
	echo >> Makefile
	cat Makefile.in >> Makefile
	
