\chapter{Boltzmann Inversion}
\begin{figure}
   \centering
   \includegraphics{usage/fig/flow_boltzmann.eps}
   \caption{Flowchart to perform Boltzmann inversion.}
\end{figure}

Boltzmann inversion is most often performed on a single molecule in vacuum for deriving bonded interactions while the non-bonded parts are treated via a separate method. VOTCA offers tools to analyze distributions and correlations of such a simulation as well as the preparation of a tabulated potential. Also, when the separation ansatz\cite{Tschoep:1998} is used, exclusion lists for the atomistic simulations can be created automatically. The tool most often used in this section is \prog{csg_boltzmann}. In addition,  mapping from the atomistic to the coarse-grained level can be performed using \prog{csg_map}. An important thing to remember when using \prog{csg_boltzmann} is that it parses the whole trajectory and stores all information about bonded interactions in memory, allowing interactive analysis. Hence it is not suitable for really big systems with lots of chains. If analysis of a big system is performed, \prog{csg_stat} should be preferred for the analysis. Although it currently offers less features than \prog{csg_boltzmann}, memory problems should not occur.

\section{Mapping scheme}
The first thing to coarse-grain a system is to define a mapping scheme (see \sect{sec:mapping}). The mapping is defined by a simple xml file for each molecule-type. An important step is to verify the mapping scheme by:

\begin{verbatim}
  csg_map --top topol.tpr --trj traj.trr --cg mapping.xml --out cg.gro
\end{verbatim}

Make sure that the \mapopt{ident} tag matches the molecule name in the reference system. One of the most common things that can go wrong is that beads cannot be found due to wrong naming. To debug which atoms are read in from a topology file, \prog{csg_dump} can be used. A second reason could be, that molecules are not identified correctly for the case of a multicomponent system. See \sect{sec:adv_topology} for details.

In case everything works as desired, a file cg.gro is created which contains the coarse-grained trajectory. An easy way to compare coarse-grained and atomistic representations is to open both in a visualization program (e.g. vmd).  In vmd, be careful when e.g. opening a .gro and .trr file. In this case, the first frame is read from the .gro and all of the following from the .trr. The coarse-grained file only contains the frames from the trajectory, thus in order to compare the trajectories, the first frame of the atomistic run has to be deleted!!

\section{Generating reference trajectories with proper exclusions}
When the Boltzmann inversion method was described in Ref.\cite{Tschoep:1998}, bonded and non-bonded interactions were treated separately. To do this, a special atomistic trajectory is needed, where all non-bonded interactions are excluded which do not contribute to a bonded interaction in the coarse-grained model. Manually, this can be a complicated task, but \prog{csg_boltzmann} offers the option \progopt{--excl} to do this automatically.

To generate an exclusion list, an atomistic topology without exclusions and a mapping scheme has to be prepared first. Since \votca can currently only read GROMACS .tpr trajectories and not .top files, running \progex{grompp} is obligatory. Important to note here is, that \prog{csg_boltzmann} currently only creates the exclusion list for the fist mulecule in the topology.

To create the exclusion list, run
\begin{verbatim}
  csg_boltzmann --top topol.tpr --cg mapping.xml --excl exclusions.txt
\end{verbatim}
This will create a list of exclusions for all interactions that are not within a bonded interaction of the coarse-grained sub-bead. As an example consider coarse-graining of a linear chain of three beads  which are only connected by bonds. In this case, \prog{csg_boltzmann} will create exclusions for all non-bonded interactions of atoms in the first bead with atoms of the 3rd bead as these would contribute only to the non-bonded interaction potential which is treated separately.

To add the exclusions to the \gromacs topology of the molecule, either include the file specified in --excl as follows
\begin{verbatim}
  [ exclusions ]
  #include "exclusions.txt"
\end{verbatim}
or copy and paste the content of that file to the exclusions section.


\section{Analysis}
If the \progopt{--trj} option is specified to parse a reference trajectory, \prog{csg_boltzmann} enters an interactive mode which accepts commands. Here, analysis operations can be performed on all interactions evaluated.

\begin{verbatim}
  csg_boltzmann --top topol.top --trj traj.trr --cg mapping.xml
\end{verbatim}

The interactive mode contains a built in \textit{help} command. To get help on a specific command use
\begin{verbatim}
  help <command>
\end{verbatim}
for example
\begin{verbatim}
  help hist
  help hist set periodic
\end{verbatim}

All interactions specified in the mapping scheme are evaluated. A specific interaction is referred to by a name which is composed of \textit{molecule:interaction-group:index}, where molecule is the molecule number in the whole topology, interaction-group the name specified in the mapping file, and index the entry in the list of interactions. E.g. \textit{1:AA-bond:10} is the 10th AA-bond in molecule 1. To show a list of all interactions that where passed, the command \textit{list} can be used. To specify a couple of interactions during analysis, either give interactions separated by space or use wildcards (e.g. *:AA-bond*).

To exit the interactive mode, use the command \textit{q}. If analysis commands are t be read from a file, use the pipe or stdin redirects from the shell.
\begin{verbatim}
  cat commands | csg_boltzmann topol.top --trj traj.trr --cg mapping.xml
\end{verbatim}

\subsection{Distribution functions and tabulated potentials}
Distribution functions (tabulated potentials) can be created with the \textit{hist} (\textit{tab}) command.
E.g. to write out the distribution function for all interactions of group AA-bond (where AA-bond is the name specified in the mapping scheme) to the file AA.txt, type
\begin{verbatim}
  hist AA.txt *:AA-bond:*
\end{verbatim}
The command
\begin{verbatim}
  hist set
\end{verbatim}
prints a list of all parameters that can be changed for the histogram. To directly write the Boltzmann-inverted potential, the \textit{tab} command can be used. Its usage and options are very similar to the \textit{hist} command. If tabulated potentials are written, special care should be taken to the parameters \textit{T} (temperature) and the \textit{scale}. The \textit{scale} enables volume normalization as given in \eq{eq:boltzmann_norm}. Possible values are \textit{no} (no scaling), \textit{bond} (normalize for bonds) and \textit{angle} (normalize for angles). E.g. to write out the tabulated potential for an angle potential where the temperature is 300K type:
\begin{verbatim}
  tab set T 300
  tab set scale angle
  tab angle.pot *:angle:*
\end{verbatim}

\subsection{Correlation analysis}
\prog{csg_boltzmann} offers two possibilities to evaluate correlations of interactions. On thing is the linear correlation coefficient using the command \textit{cor}. However this is not a good measure since it only calculates the linear correlation and often give misleading results~\cite{Ruehle:2009.a}. A better way is to create 2D Histograms. This can be performed by writing out the values (e.g. bond length, angle, dihedral value) using the command \textit{vals}, e.g.:
\begin{verbatim}
  vals vals.txt 1:AA-bond:1 1:AAA-angle:A
\end{verbatim}
This will create a file which contains 3 columns, the first being the time, and the second and third the bond and angle, respectively. Columns 2 and 3 can either be used to generate the 2D Histogram, or a simpler plot of column 3 over 2, whose density of points reflect the probability.
